<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <title>Codex Design Chat</title>
        <style>
            * {
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    sans-serif;
                margin: 0;
                padding: 12px;
                background: #f5f5f7;
                color: #1a1a1a;
            }

            #chat {
                display: flex;
                flex-direction: column;
                height: 100%;
                gap: 10px;
            }

            #messages {
                flex: 1;
                overflow-y: auto;
                padding: 10px;
                background: #ffffff;
                border: 1px solid #dcdcdc;
                border-radius: 8px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .bubble {
                padding: 8px 10px;
                border-radius: 6px;
                line-height: 1.5;
                white-space: pre-wrap;
                word-break: break-word;
            }

            .bubble.user {
                background: #0065ff;
                color: #ffffff;
                align-self: flex-end;
            }

            .bubble.assistant {
                background: #f0f4ff;
                color: #182a4d;
                align-self: flex-start;
            }

            .header {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .title {
                font-size: 16px;
                font-weight: 600;
            }

            .subtitle {
                font-size: 12px;
                color: #555961;
            }

            form {
                display: flex;
                gap: 8px;
            }

            input[type="text"] {
                flex: 1;
                border-radius: 8px;
                border: 1px solid #c5c8d0;
                padding: 8px 10px;
                font-size: 13px;
            }

            button {
                border-radius: 8px;
                border: none;
                padding: 8px 14px;
                background: #0065ff;
                color: #ffffff;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s ease;
            }

            button[disabled] {
                background: #a3b9ff;
                cursor: not-allowed;
            }

            button:not([disabled]):hover {
                background: #0050cc;
            }

            .status {
                font-size: 12px;
                color: #70737c;
                min-height: 16px;
            }
        </style>
    </head>
    <body>
        <div id="chat">
            <div class="header">
                <div class="title">Codex Design Chat</div>
                <div class="subtitle">
                    Figmaã®ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’è¸ã¾ãˆã¦ç›¸è«‡ã§ãã¾ã™ã€‚
                </div>
            </div>
            <div id="messages"></div>
            <div class="status" id="status"></div>
            <form id="composer">
                <input
                    id="input"
                    type="text"
                    placeholder="Codexã«ç›¸è«‡ã™ã‚‹å†…å®¹ã‚’å…¥åŠ›..."
                    autocomplete="off"
                />
                <button id="send" type="submit">é€ä¿¡</button>
            </form>
        </div>

        <script>
            const messages = document.getElementById("messages");
            const input = document.getElementById("input");
            const statusEl = document.getElementById("status");
            const composer = document.getElementById("composer");
            const history = [];

            function appendMessage(role, text) {
                const bubble = document.createElement("div");
                bubble.className = `bubble ${role}`;
                bubble.textContent = text;
                messages.appendChild(bubble);
                messages.scrollTop = messages.scrollHeight;
            }

            function setStatus(text) {
                statusEl.textContent = text ?? "";
            }

            function setSending(isSending) {
                input.disabled = isSending;
                composer.querySelector("button").disabled = isSending;
                if (isSending) {
                    setStatus("Codexã«å•ã„åˆã‚ã›ä¸­...");
                } else {
                    setStatus("");
                }
            }

            function handleSend(evt) {
                evt.preventDefault();
                const value = input.value.trim();
                if (!value) return;

                appendMessage("user", value);
                history.push({ role: "user", content: value });
                parent.postMessage(
                    {
                        pluginMessage: {
                            type: "userQuery",
                            text: value,
                            history,
                        },
                    },
                    "*"
                );
                input.value = "";
                setSending(true);
            }

            composer.addEventListener("submit", handleSend);

            window.addEventListener("message", (event) => {
                const message = event.data.pluginMessage;
                if (!message) return;

                if (message.type === "codexResponse") {
                    appendMessage("assistant", message.text);
                    history.push({ role: "assistant", content: message.text });
                    setSending(false);
                }

                if (message.type === "error") {
                    // CORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ç‰¹åˆ¥ãªã‚¹ã‚¿ã‚¤ãƒ«ã§è¡¨ç¤º
                    const isCorsError =
                        message.text.includes("CORS") ||
                        message.text.includes("Access-Control-Allow-Origin");
                    if (isCorsError) {
                        appendMessage(
                            "assistant",
                            `ğŸš« ${message.text}\n\nğŸ’¡ è§£æ±ºæ–¹æ³•:\n1. ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª\n2. ãƒãƒ¼ãƒˆ5000ãŒä½¿ç”¨å¯èƒ½ã‹ç¢ºèª\n3. ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª`
                        );
                    } else {
                        appendMessage("assistant", message.text);
                    }
                    setSending(false);
                }
            });
        </script>
    </body>
</html>
